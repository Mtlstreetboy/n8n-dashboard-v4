flowchart TB
    subgraph SOURCES["ğŸ“¥ SOURCES EXTERNES"]
        direction TB
        GNEWS["ğŸ” Google News<br/>gnews library"]
        YAHOO["ğŸ“Š Yahoo Finance<br/>yfinance API"]
        subgraph LOCAL_AI["ï¿½ LOCAL AI (Dual Brain)"]
            direction LR
            QWEN["ğŸ¤– System 2: Qwen 2.5 7B<br/>(Logic & Config)"]
            LLAMA["ğŸ—£ï¸ System 1: Llama 3.1 8B<br/>(Narrative & Context)"]
        end
    end

    subgraph CONFIG["âš™ï¸ CONFIGURATION"]
        COMPANIES["companies_config.py<br/>15 AI Tickers"]
    end

    subgraph COLLECTORS["ğŸ“¦ PHASE 1: COLLECTE (Batch)"]
        direction TB
        BATCH["batch_loader_v2.py<br/>â±ï¸ Parallel: 3 tickers Ã— 8 workers<br/>ğŸ“… 160 jours historique"]
        COLLECT_NEWS["collect_companies.py<br/>ğŸ“° Single ticker collection"]
        COLLECT_OPT["collect_options.py<br/>ğŸ“ˆ Options + Greeks"]
    end

    subgraph DATA_LAYER["ğŸ’¾ STOCKAGE DONNÃ‰ES"]
        direction LR
        NEWS_JSON["/data/files/companies/<br/>TICKER_news.json"]
        OPTIONS_JSON["/data/options_data/<br/>TICKER_latest_sentiment.json"]
        SENTIMENT_JSON["/data/sentiment_analysis/<br/>TICKER_latest_v4.json"]
    end

    subgraph ANALYZERS["ğŸ§  PHASE 2: ANALYSE SENTIMENT V4"]
        direction TB
        V4_ENGINE["advanced_sentiment_engine_v4.py<br/>(Dual Brain Engine)"]
        
        subgraph DIMENSIONS["6 Dimensions d'Analyse"]
            direction LR
            DIM1["ğŸ“° News<br/>LLM Enhanced"]
            DIM2["ğŸ“Š Options<br/>Put/Call Ratio"]
            DIM3["ğŸ¯ Analysts<br/>Just-in-Time"]
            DIM4["ğŸŒªï¸ Volatility<br/>Regime Detection"]
            DIM5["ğŸ” Catalysts<br/>Auto Detection"]
            DIM6["ğŸš¨ Alerts<br/>Smart System"]
        end
        
        ANALYST["analyst_insights_integration.py<br/>Live Fetch (Lazy)"]
        AGGREGATE["analyze_all_sentiment.py<br/>Batch all tickers"]
    end

    subgraph DASHBOARDS["ğŸ“Š PHASE 3: VISUALISATION"]
        direction TB
        SERVER["sentiment_server.py<br/>HTTP API :8501"]
        DASH_SENT["dashboard_sentiment.html<br/>React + Tailwind"]
        DASH_OPT["dashboard_options.py<br/>Streamlit"]
        DASH_TIME["dashboard_timeline.py<br/>Streamlit"]
    end

    subgraph N8N_ORCH["ğŸ”„ ORCHESTRATION n8n"]
        direction TB
        TRIGGER["â° Schedule Trigger<br/>Daily 6h00"]
        WORKFLOW["Workflow Pipeline"]
        NOTIF["ğŸ“§ Notifications<br/>Slack/Email"]
        ERROR["ğŸš¨ Error Handler"]
    end

    %% Connexions Sources -> Collectors
    GNEWS --> BATCH
    GNEWS --> COLLECT_NEWS
    YAHOO --> COLLECT_OPT
    YAHOO --> ANALYST
    CONFIG --> BATCH
    CONFIG --> COLLECT_OPT

    %% Connexions Collectors -> Data
    BATCH --> NEWS_JSON
    COLLECT_NEWS --> NEWS_JSON
    COLLECT_OPT --> OPTIONS_JSON

    %% Connexions Data -> Analyzers
    NEWS_JSON --> V4_ENGINE
    OPTIONS_JSON --> V4_ENGINE
    
    %% Connexions AI -> Engine
    QWEN -- "Config & Math" --> V4_ENGINE
    LLAMA -- "Narrative & Synthesis" --> V4_ENGINE
    ANALYST -- "Live Insights" --> V4_ENGINE

    %% Connexions internes Analyzers
    V4_ENGINE --> DIMENSIONS
    V4_ENGINE --> SENTIMENT_JSON
    V4_ENGINE --> AGGREGATE

    %% Connexions Analyzers -> Dashboards
    SENTIMENT_JSON --> SERVER
    OPTIONS_JSON --> DASH_OPT
    SERVER --> DASH_SENT

    %% Connexions n8n
    TRIGGER --> WORKFLOW
    WORKFLOW -.-> BATCH
    WORKFLOW -.-> COLLECT_OPT
    WORKFLOW -.-> V4_ENGINE
    WORKFLOW --> NOTIF
    WORKFLOW --> ERROR

    %% Styles
    classDef source fill:#e1f5fe,stroke:#01579b,color:black
    classDef ai fill:#e8eaf6,stroke:#3f51b5,color:black
    classDef collector fill:#fff3e0,stroke:#e65100,color:black
    classDef analyzer fill:#f3e5f5,stroke:#7b1fa2,color:black
    classDef data fill:#e8f5e9,stroke:#2e7d32,color:black
    classDef dashboard fill:#fce4ec,stroke:#c2185b,color:black
    classDef n8n fill:#fff8e1,stroke:#f57f17,color:black

    class GNEWS,YAHOO source
    class QWEN,LLAMA ai
    class BATCH,COLLECT_NEWS,COLLECT_OPT collector
    class V4_ENGINE,ANALYST,AGGREGATE,DIM1,DIM2,DIM3,DIM4,DIM5,DIM6 analyzer
    class NEWS_JSON,OPTIONS_JSON,SENTIMENT_JSON data
    class SERVER,DASH_SENT,DASH_OPT,DASH_TIME dashboard
    class TRIGGER,WORKFLOW,NOTIF,ERROR n8n
