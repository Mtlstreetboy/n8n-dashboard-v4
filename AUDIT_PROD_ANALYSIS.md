# ğŸ“Š AUDIT COMPLET - prod/ Directory Analysis

**Date:** 2025-12-30 | **Status:** Complete  
**Repository:** c:\n8n-local-stack | **Scope:** Production code and dashboards

---

## ğŸ¯ Executive Summary

### âš ï¸ Important Finding
The file you're working with (`dashboard_v4_split.html`) **does NOT exist** in the current codebase. The actual active dashboard file is:
- **`prod/dashboard/dashboard_v4_3levels.html`** (generated file)

This is generated by `prod/dashboard/generate_dashboard_3levels.py` from aggregated sentiment + options + news data.

---

## ğŸ“ Section 1: Chemin Critique Complet

### Data Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DAILY AUTOMATION PIPELINE                          â”‚
â”‚        (prod/automation/daily_automation.py)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼            â–¼            â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ NEWS   â”‚  â”‚OPTIONS â”‚  â”‚ SENTIMENT  â”‚  â”‚DASHBOARD â”‚
    â”‚COLLECT â”‚  â”‚COLLECT â”‚  â”‚  ANALYSIS  â”‚  â”‚GENERATE  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚            â”‚              â”‚
         â–¼           â–¼            â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     local_files/ (or /data/ in Docker)         â”‚
    â”‚  - sentiment_analysis/{TICKER}_latest_v4.json  â”‚
    â”‚  - options_data/{TICKER}_latest_sentiment.json â”‚
    â”‚  - companies/{TICKER}_news.json                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  dashboard_v4_3levels.html (SPA)  â”‚
         â”‚  (Interactive, embedded data)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¥ Data Sources

| Source | Location | Producer | Frequency |
|--------|----------|----------|-----------|
| **News Articles** | `local_files/companies/{TICKER}_news.json` | `scripts/collect_news.py` | Daily (quota-aware) |
| **Options Data** | `local_files/options_data/{TICKER}_latest_sentiment.json` | `prod/collection/collect_options.py` | Daily |
| **Sentiment Analysis** | `local_files/sentiment_analysis/{TICKER}_latest_v4.json` | `prod/analysis/advanced_sentiment_engine_v4.py` | Daily |

### ğŸ§  AI Models Used

The sentiment analysis uses a **Dual-Brain architecture**:

1. **System 2 (Logic)**: `Qwen 2.5 7B`
   - JSON structure generation
   - Mathematical calculations
   - Configuration optimization

2. **System 1 (Narrative)**: `Llama 3.1 8B`
   - Narrative interpretation
   - Story telling
   - Nuance detection

3. **Fallback**: `FinBERT` (transformer-based sentiment)

---

## ğŸ“‹ Section 2: Audit Complet du Dossier prod/

### Overview Statistics

| Metric | Value |
|--------|-------|
| **Total Files** | 47 |
| **Total Directories** | 8 |
| **Active Files** | 25 |
| **Inactive Files** | 15 |
| **Cache/Generated** | 7 |

### Active Production Files (Critical Path)

#### ğŸ”´ TIER 1 - Must Keep (Core)

```
prod/
â”œâ”€â”€ analysis/
â”‚   â”œâ”€â”€ analyze_all_sentiment.py          [192 lines] âš™ï¸ BATCH LAUNCHER
â”‚   â”œâ”€â”€ advanced_sentiment_engine_v4.py   [1380 lines] ğŸ§  DUAL-BRAIN ENGINE
â”‚   â”œâ”€â”€ finbert_analyzer.py               ğŸ”„ FALLBACK SENTIMENT
â”‚   â”œâ”€â”€ analyst_insights_integration.py   ğŸ“Š ANALYST INSIGHTS
â”‚   â””â”€â”€ (5 more analysis modules)         
â”œâ”€â”€ automation/
â”‚   â””â”€â”€ daily_automation.py               [166 lines] ğŸ¬ ORCHESTRATOR
â”œâ”€â”€ collection/
â”‚   â”œâ”€â”€ collect_options.py                [411 lines] ğŸ“ˆ OPTIONS COLLECTOR
â”‚   â”œâ”€â”€ collect_options_worker.py         ğŸ”„ PARALLEL WORKER
â”‚   â””â”€â”€ batch_loader_v2.py               ğŸ“¦ BATCH LOADER
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ generate_dashboard_3levels.py     [1493 lines] ğŸ–¼ï¸ GENERATOR
â”‚   â”œâ”€â”€ dashboard_options.py              [874 lines] ğŸ“Š STREAMLIT APP
â”‚   â”œâ”€â”€ dashboard_companies.py            ğŸ“Š STREAMLIT APP
â”‚   â””â”€â”€ dashboard_timeline.py             ğŸ“Š STREAMLIT APP
â””â”€â”€ config/
    â””â”€â”€ companies_config.py               [171 lines] ğŸ¯ MASTER CONFIG
```

**Dependencies Chain:**
```
daily_automation.py
â”œâ”€â”€ analyze_all_sentiment.py
â”‚   â””â”€â”€ advanced_sentiment_engine_v4.py
â”‚       â”œâ”€â”€ finbert_analyzer.py
â”‚       â””â”€â”€ analyst_insights_integration.py
â”œâ”€â”€ collect_options.py
â”‚   â””â”€â”€ companies_config.py
â””â”€â”€ generate_dashboard_3levels.py
    â””â”€â”€ (reads all output files)
```

#### ğŸŸ¡ TIER 2 - Supporting

```
prod/utils/
â”œâ”€â”€ sentiment_server.py      HTTP API (port 8000)
â”œâ”€â”€ check_llm_status.py      Ollama health checks
â”œâ”€â”€ monitor_batch_v2.py      Progress tracking
â””â”€â”€ populate_fetched_dates.py Metadata management

prod/tests/
â””â”€â”€ test_options_dashboard.py Integration tests
```

#### ğŸ”µ TIER 3 - Historical (Archive)

```
prod/_archive/cleanup_2025/
â”œâ”€â”€ advanced_sentiment_engine_v3.py   âŒ OBSOLETE (V3)
â”œâ”€â”€ dashboard_*.html                  âŒ OLD VERSIONS
â”œâ”€â”€ generate_dashboard*.py            âŒ OLD GENERATORS
â”œâ”€â”€ merge_*.py                        âŒ OBSOLETE (now integrated)
â””â”€â”€ run_v3_all.sh                     âŒ OLD SHELL SCRIPT
```

### Duplication & Obsolescence

| Item | Active | Inactive | Status |
|------|--------|----------|--------|
| **Sentiment Engines** | V4 | V3 | V4 is improved dual-brain |
| **Dashboard Generators** | 1 (3levels) | 3 (spa, final, old) | Unified to single version |
| **Merge Utilities** | 0 | 3 | Integrated into generator |
| **Configuration** | 1 | 0 | No duplication âœ… |

---

## ğŸ—ï¸ Section 3: Architecture ProposÃ©e

### Current Issues

âŒ Archive folder mixed in with prod root  
âŒ No separation between batch (pipelines) and serving (dashboards)  
âŒ Utilities scattered  
âŒ Test file location non-standard  
âŒ Generated artifacts in source directories  

### Recommended Structure

```
prod/
â”œâ”€â”€ pipelines/                      [DATA PROCESSING]
â”‚   â”œâ”€â”€ collection/
â”‚   â”‚   â”œâ”€â”€ collect_options.py
â”‚   â”‚   â”œâ”€â”€ collect_options_worker.py
â”‚   â”‚   â””â”€â”€ batch_loader_v2.py
â”‚   â”œâ”€â”€ analysis/
â”‚   â”‚   â”œâ”€â”€ advanced_sentiment_engine_v4.py
â”‚   â”‚   â”œâ”€â”€ analyze_all_sentiment.py
â”‚   â”‚   â””â”€â”€ (7 more analysis modules)
â”‚   â””â”€â”€ automation/
â”‚       â””â”€â”€ daily_automation.py
â”‚
â”œâ”€â”€ dashboards/                     [USER INTERFACES]
â”‚   â”œâ”€â”€ streamlit/
â”‚   â”‚   â”œâ”€â”€ dashboard_options.py
â”‚   â”‚   â”œâ”€â”€ dashboard_companies.py
â”‚   â”‚   â””â”€â”€ dashboard_timeline.py
â”‚   â”œâ”€â”€ generators/
â”‚   â”‚   â””â”€â”€ generate_dashboard_3levels.py
â”‚   â””â”€â”€ html/                       [GENERATED - NOT SOURCE]
â”‚       â””â”€â”€ dashboard_v4_3levels.html
â”‚
â”œâ”€â”€ services/                       [BACKEND SERVICES]
â”‚   â”œâ”€â”€ sentiment_server.py
â”‚   â”œâ”€â”€ check_llm_status.py
â”‚   â””â”€â”€ monitor_batch_v2.py
â”‚
â”œâ”€â”€ config/                         [CONFIGURATION]
â”‚   â”œâ”€â”€ companies_config.py
â”‚   â”œâ”€â”€ constants.py
â”‚   â””â”€â”€ paths.py
â”‚
â”œâ”€â”€ utils/                          [SHARED UTILITIES]
â”‚   â”œâ”€â”€ path_utils.py
â”‚   â”œâ”€â”€ data_utils.py
â”‚   â”œâ”€â”€ llm_utils.py
â”‚   â””â”€â”€ encoding_utils.py
â”‚
â”œâ”€â”€ tests/                          [TEST SUITE]
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ fixtures/
â”‚
â””â”€â”€ docs/                           [INTERNAL DOCS]
    â”œâ”€â”€ PIPELINE_ARCHITECTURE.md
    â”œâ”€â”€ API_REFERENCE.md
    â””â”€â”€ SETUP_GUIDE.md

build/                              [GENERATED - NOT SOURCE]
â”œâ”€â”€ html/
â”‚   â””â”€â”€ dashboard_v4_3levels.html
â””â”€â”€ reports/
    â””â”€â”€ consolidated_report.csv

archive/                            [HISTORICAL CODE]
â”œâ”€â”€ v3/
â”œâ”€â”€ dashboards_historical/
â”œâ”€â”€ generators_old/
â””â”€â”€ README_ARCHIVE.md
```

### Benefits

âœ… **Clear responsibilities** - each module has one job  
âœ… **Easy navigation** - new developers understand structure  
âœ… **Scalable** - add new modules without cluttering  
âœ… **Safe** - generated artifacts separate, archive isolated  
âœ… **Standard** - follows Python project conventions  

---

## ğŸš€ Quick Wins (Immediate Actions)

### 1. Move Archive (5 minutes)
```bash
mkdir archive
mv prod/_archive/cleanup_2025/* archive/
rmdir prod/_archive/cleanup_2025
```

### 2. Create Proper Test Directory (30 minutes)
```bash
mkdir -p prod/tests/{unit,integration,fixtures}
mv prod/tests/test_options_dashboard.py prod/tests/integration/
```

### 3. Create Config for Path Resolution (1 hour)
Create `prod/utils/path_utils.py`:
```python
def get_data_root() -> Path:
    """Smart path resolution for Docker vs local."""
    if (Path('/data/scripts')).exists():
        return Path('/data')
    else:
        return (Path(__file__).parent.parent.parent) / 'local_files'
```

Then use in all modules:
```python
from utils.path_utils import get_data_root
DATA_ROOT = get_data_root()
```

### 4. Update .gitignore (10 minutes)
```
build/
__pycache__/
*.pyc
.pytest_cache/
*.log
local_files/sentiment_analysis/
local_files/options_data/
local_files/companies/
.venv*/
```

### 5. Create Dashboard Generators Subdir (15 minutes)
```bash
mkdir prod/dashboards/generators
mv prod/dashboard/generate_dashboard_3levels.py prod/dashboards/generators/
```

---

## ğŸ“Š Data Paths Reference

### Docker (Container)
```
/data/
â”œâ”€â”€ sentiment_analysis/      â† Output of analysis pipeline
â”œâ”€â”€ options_data/            â† Output of options collector
â”œâ”€â”€ files/companies/         â† News articles
â””â”€â”€ sentiment_analysis/consolidated_sentiment_report.csv
```

### Windows Local
```
local_files/
â”œâ”€â”€ sentiment_analysis/      â† Output of analysis pipeline
â”œâ”€â”€ options_data/            â† Output of options collector
â”œâ”€â”€ companies/               â† News articles
â””â”€â”€ sentiment_cache/         â† Intermediate results
```

### Environment Variable Overrides
```python
# Docker
os.environ['FINBERT_API_URL'] = 'http://localhost:8089'
os.environ['OLLAMA_API_URL'] = 'http://host.docker.internal:11434/api/generate'

# Windows
os.environ['OPTIONS_DATA_DIR'] = './data_local/options_data'
os.environ['PYTHONUTF8'] = '1'
```

---

## ğŸ”— File Dependency Graph

```
companies_config.py â—„â”€â”€â”€â”€â”€â”€â”
    â–²                       â”‚
    â”‚                       â”‚
    â”œâ”€ collect_options.py â”€â”€â”¤
    â”œâ”€ analyze_all_sentiment.py â”€â”€â”¤
    â””â”€ aggregate_companies.py â”€â”€â”€â”€â”¤
         â”‚
         â–¼
    advanced_sentiment_engine_v4.py
         â”‚
         â”œâ”€â–º finbert_analyzer.py
         â””â”€â–º analyst_insights_integration.py
                  â”‚
                  â–¼
            generate_dashboard_3levels.py
                  â”‚
                  â–¼
         dashboard_v4_3levels.html (SPA)
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼        â–¼        â–¼
    Streamlit   Static  HTTP Server
    Apps       HTML    (sentiment_server.py)
```

---

## ğŸ“ˆ Tickers Analyzed (15 total)

From `prod/config/companies_config.py`:

| Ticker | Company | Sector | Status |
|--------|---------|--------|--------|
| NVDA | NVIDIA Corporation | AI Hardware | âœ… Options |
| MSFT | Microsoft | AI Software | âœ… Options |
| GOOGL | Alphabet Inc | AI Software | âœ… Options |
| META | Meta Platforms | AI Software | âœ… Options |
| AMZN | Amazon.com | AI Cloud | âœ… Options |
| AMD | Advanced Micro Devices | AI Hardware | âœ… Options |
| TSLA | Tesla Inc | AI Automotive | âœ… Options |
| ORCL | Oracle | AI Database | âœ… Options |
| CRM | Salesforce | AI Software | âœ… Options |
| PLTR | Palantir | AI Analytics | âœ… Options |
| SNOW | Snowflake | AI Analytics | âœ… Options |
| AVGO | Broadcom | AI Hardware | âœ… Options |
| ADBE | Adobe | AI Creative | âœ… Options |
| NOW | ServiceNow | AI Automation | âœ… Options |
| INTC | Intel | AI Hardware | âœ… Options |

---

## âœ… Validation Checklist

Before deploying the reorganization:

- [ ] All imports updated to new structure
- [ ] Run `pytest prod/tests/` (all tests pass)
- [ ] Test local execution: `python prod/pipelines/analysis/analyze_all_sentiment.py`
- [ ] Test Docker execution: `docker exec n8n_data_architect python3 /data/scripts/daily_automation.py`
- [ ] Generate dashboard: `python prod/dashboards/generators/generate_dashboard_3levels.py`
- [ ] Verify dashboard HTML in browser
- [ ] Test Streamlit apps: `streamlit run prod/dashboards/streamlit/dashboard_options.py --server.port 8502`
- [ ] Verify sentiment_server API: `curl http://localhost:8000/api/tickers`

---

## ğŸ“š Related Documentation

- **Full JSON Report**: `AUDIT_PROD_COMPLET.json` (this directory)
- **Setup Guides**: `docs/RUN_OPTIONS_LOCALLY.md`, `docs/GUIDE_EXECUTION.md`
- **Integration Plan**: `docs/guides/INTEGRATION_OPTIONS_SENTIMENT.md`
- **Copilot Instructions**: `.github/copilot-instructions.md`

---

## ğŸ¯ Next Steps

1. **Review this report** - Understand current architecture
2. **Decide on reorganization** - Accept proposal or customize
3. **Create test environment** - Test changes safely
4. **Execute migration** - Follow phase-by-phase plan
5. **Validate** - Run complete test suite
6. **Deploy** - Merge to prod with confidence

---

**Questions?** Check `AUDIT_PROD_COMPLET.json` for detailed analysis of each file.
